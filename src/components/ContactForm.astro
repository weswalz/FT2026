---
interface Props {
  type?: 'contact' | 'private-dining';
  variant?: 'default' | 'split';
}

const { type = 'contact', variant = 'default' } = Astro.props;
const splitName = variant === 'split';
---

<form
  id={`${type}-form`}
  class="space-y-6"
  data-form-type={type}
>
{splitName ? (
    <>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="first_name" class="block text-sm font-medium text-midnight mb-2">
            First Name <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="first_name"
            name="first_name"
            required
            class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
            placeholder="First Name"
          />
        </div>
        <div>
          <label for="last_name" class="block text-sm font-medium text-midnight mb-2">
            Last Name <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="last_name"
            name="last_name"
            required
            class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
            placeholder="Last Name"
          />
        </div>
      </div>
      <input type="hidden" name="name" value="" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="email" class="block text-sm font-medium text-midnight mb-2">
            Email Address <span class="text-red-500">*</span>
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
            placeholder="Email Address"
          />
        </div>
        <div>
          <label for="phone" class="block text-sm font-medium text-midnight mb-2">
            Phone/Mobile <span class="text-red-500">*</span>
          </label>
          <input
            type="tel"
            id="phone"
            name="phone"
            required
            class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
            placeholder="Mobile Number"
          />
        </div>
      </div>
      {type === 'private-dining' && (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="event_date" class="block text-sm font-medium text-midnight mb-2">
              Reservation Date <span class="text-red-500">*</span>
            </label>
            <input
              type="date"
              id="event_date"
              name="event_date"
              required
              class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
            />
          </div>
          <div>
            <label for="guest_count" class="block text-sm font-medium text-midnight mb-2">
              Size of Party <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="guest_count"
              name="guest_count"
              min="1"
              required
              class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
              placeholder="Number of Guests"
            />
          </div>
        </div>
      )}
    </>
  ) : (
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="name" class="block text-sm font-medium text-midnight mb-2">
          Full Name <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="name"
          name="name"
          required
          class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
          placeholder="John Doe"
        />
      </div>

      <div>
        <label for="email" class="block text-sm font-medium text-midnight mb-2">
          Email Address <span class="text-red-500">*</span>
        </label>
        <input
          type="email"
          id="email"
          name="email"
          required
          class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
          placeholder="john@example.com"
        />
      </div>
    </div>
  )}

  {!splitName && (
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="phone" class="block text-sm font-medium text-midnight mb-2">
          Phone Number {type === 'private-dining' && <span class="text-red-500">*</span>}
        </label>
        <input
          type="tel"
          id="phone"
          name="phone"
          required={type === 'private-dining'}
          class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
          placeholder="(555) 123-4567"
        />
      </div>

    </div>
  )}

  {type === 'private-dining' && !splitName && (
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="event_date" class="block text-sm font-medium text-midnight mb-2">
          Reservation Date <span class="text-red-500">*</span>
        </label>
        <input
          type="date"
          id="event_date"
          name="event_date"
          required
          class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
        />
      </div>
      <div>
        <label for="guest_count" class="block text-sm font-medium text-midnight mb-2">
          Size of Party <span class="text-red-500">*</span>
        </label>
        <input
          type="number"
          id="guest_count"
          name="guest_count"
          min="1"
          required
          class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none"
          placeholder="Number of Guests"
        />
      </div>
    </div>
  )}

  <div>
    <label for="message" class="block text-sm font-medium text-midnight mb-2">
      {type === 'private-dining' ? 'Additional Info or Questions' : 'Message'} <span class="text-red-500">*</span>
    </label>
    <textarea
      id="message"
      name="message"
      rows="6"
      required
      class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-field-navy focus:ring-2 focus:ring-field-navy/20 transition-all outline-none resize-none"
      placeholder={type === 'private-dining' ? 'Special occasion? Special requests? Let us know!' : 'Your message...'}
    ></textarea>
  </div>

  <!-- Status Messages -->
  <div id="form-status" class="hidden">
    <div class="p-4 rounded-lg" id="status-message"></div>
  </div>

  <div>
    <button
      type="submit"
      class="btn btn-primary w-full md:w-auto min-w-[200px]"
      id="submit-btn"
    >
      <span class="submit-text">{type === 'private-dining' ? 'Submit' : 'Send Message'}</span>
      <span class="loading-text hidden">
        <svg class="animate-spin h-5 w-5 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Sending...
      </span>
    </button>
  </div>
</form>

<script>
  function initForm() {
    const forms = document.querySelectorAll('[data-form-type]');

    forms.forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formElement = e.target as HTMLFormElement;
        const formType = formElement.dataset.formType;
        const submitBtn = formElement.querySelector('#submit-btn') as HTMLButtonElement;
        const submitText = submitBtn?.querySelector('.submit-text');
        const loadingText = submitBtn?.querySelector('.loading-text');
        const statusDiv = formElement.querySelector('#form-status');
        const statusMessage = formElement.querySelector('#status-message');

        // Disable button and show loading
        if (submitBtn) {
          submitBtn.disabled = true;
          submitText?.classList.add('hidden');
          loadingText?.classList.remove('hidden');
        }

        // Get form data
        const formData = new FormData(formElement);
        const firstNameInput = formElement.querySelector('[name="first_name"]') as HTMLInputElement | null;
        const lastNameInput = formElement.querySelector('[name="last_name"]') as HTMLInputElement | null;
        if (firstNameInput || lastNameInput) {
          const combinedName = `${firstNameInput?.value.trim() ?? ''} ${lastNameInput?.value.trim() ?? ''}`.trim();
          if (combinedName.length > 0) {
            formData.set('name', combinedName);
            const hiddenName = formElement.querySelector('input[name="name"]') as HTMLInputElement | null;
            if (hiddenName) hiddenName.value = combinedName;
          }
        }
        const data = Object.fromEntries(formData.entries());

        try {
          // Send to API
          const endpoint = formType === 'private-dining' ? '/api/private-dining' : '/api/contact';
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (response.ok) {
            // Success
            statusDiv?.classList.remove('hidden');
            statusMessage?.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200');
            statusMessage?.classList.remove('bg-red-50', 'text-red-800', 'border-red-200');
            if (statusMessage) {
              statusMessage.textContent = result.message || 'Thank you! Your message has been sent successfully.';
            }

            // Reset form
            formElement.reset();
          } else {
            throw new Error(result.error || 'Failed to send message');
          }
        } catch (error) {
          // Error
          statusDiv?.classList.remove('hidden');
          statusMessage?.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
          statusMessage?.classList.remove('bg-green-50', 'text-green-800', 'border-green-200');
          if (statusMessage) {
            statusMessage.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.';
          }
        } finally {
          // Re-enable button
          if (submitBtn) {
            submitBtn.disabled = false;
            submitText?.classList.remove('hidden');
            loadingText?.classList.add('hidden');
          }
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', initForm);
  document.addEventListener('astro:page-load', initForm);
</script>
