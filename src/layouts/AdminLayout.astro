---
import { getUserFromCookie } from '../lib/auth.js';
import '../styles/admin.css';

const { pageTitle = 'Admin' } = Astro.props;

// Check authentication
const user = getUserFromCookie(Astro.cookies);

if (!user) {
  return Astro.redirect('/admin/login');
}

// Get current page for active menu highlighting
const currentPath = Astro.url.pathname;

// Navigation items
const navItems = [
  {
    title: 'Overview',
    items: [
      { name: 'Dashboard', path: '/admin/dashboard', icon: 'layout-dashboard' },
    ]
  },
  {
    title: 'Content',
    items: [
      { name: 'Menus', path: '/admin/menus', icon: 'utensils' },
      { name: 'Gallery', path: '/admin/gallery', icon: 'image' },
      { name: 'Pages', path: '/admin/pages', icon: 'file-text' },
      { name: 'Forms', path: '/admin/forms', icon: 'inbox' },
    ]
  },
  {
    title: 'Settings',
    items: [
      { name: 'Site Settings', path: '/admin/settings', icon: 'settings' },
    ]
  },
];
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{pageTitle} - Field & Tides Admin</title>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest" onload="initializeLucideIcons()"></script>
</head>
<body class="admin-layout">

  <!-- Sidebar -->
  <aside class="admin-sidebar" id="adminSidebar">

    <!-- Sidebar Header -->
    <div class="admin-sidebar-header">
      <div class="admin-sidebar-logo">
        <span class="admin-sidebar-logo-text">Field & Tides</span>
      </div>
      <button class="admin-sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
        <i data-lucide="panel-left" class="admin-nav-icon"></i>
      </button>
    </div>

    <!-- Sidebar Navigation -->
    <nav class="admin-sidebar-nav">
      {navItems.map(section => (
        <div class="admin-nav-section">
          <div class="admin-nav-section-title">{section.title}</div>
          {section.items.map(item => (
            <a
              href={item.path}
              class={`admin-nav-item ${currentPath.startsWith(item.path) ? 'active' : ''}`}
            >
              <i data-lucide={item.icon} class="admin-nav-icon"></i>
              <span class="admin-nav-text">{item.name}</span>
            </a>
          ))}
        </div>
      ))}
    </nav>

  </aside>

  <!-- Top Bar -->
  <header class="admin-topbar">

    <!-- Page Title & Mobile Menu -->
    <div style="display: flex; align-items: center; gap: 2rem;">
      <button class="admin-sidebar-toggle" id="mobileSidebarToggle" aria-label="Toggle menu" style="display: none;">
        <i data-lucide="menu" class="admin-nav-icon"></i>
      </button>
      <h1 class="admin-topbar-title">{pageTitle}</h1>
    </div>

    <!-- Top Bar Actions -->
    <div class="admin-topbar-actions">

      <!-- Search Bar -->
      <div class="admin-topbar-search">
        <i data-lucide="search" class="admin-topbar-search-icon"></i>
        <input
          type="text"
          class="admin-topbar-search-input"
          placeholder="Search..."
          id="globalSearch"
        />
      </div>

      <!-- Header Actions Slot -->
      <slot name="header-actions" />

      <!-- User Menu -->
      <div class="admin-user-menu" id="userMenu">
        <button class="admin-user-menu-trigger" id="userMenuTrigger" aria-label="User menu">
          <div class="admin-user-avatar">
            {user.username?.[0].toUpperCase() || 'A'}
          </div>
          <div class="admin-user-info">
            <span class="admin-user-name">{user.username || 'Admin'}</span>
            <span class="admin-user-role">{user.role === 'administrator' ? 'Administrator' : 'Editor'}</span>
          </div>
          <i data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
        </button>

        <!-- User Dropdown -->
        <div class="admin-user-dropdown" id="userDropdown">
          <a href="/" class="admin-dropdown-item" target="_blank">
            <i data-lucide="external-link" style="width: 16px; height: 16px;"></i>
            View Site
          </a>
          <div class="admin-dropdown-divider"></div>
          <a href="/api/auth/logout" class="admin-dropdown-item danger">
            <i data-lucide="log-out" style="width: 16px; height: 16px;"></i>
            Logout
          </a>
        </div>
      </div>

    </div>
  </header>

  <!-- Main Content -->
  <main class="admin-main">
    <div class="admin-fade-in">
      <slot />
    </div>
  </main>

  <script>
    // Initialize Lucide icons after library loads
    window.initializeLucideIcons = function() {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    };

    // Also try to initialize on DOMContentLoaded as a fallback
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    });

    // Sidebar collapse functionality
    const sidebar = document.getElementById('adminSidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');

    // Load sidebar state from localStorage
    const sidebarCollapsed = localStorage.getItem('ftAdminSidebarCollapsed') === 'true';
    if (sidebarCollapsed) {
      sidebar?.classList.add('collapsed');
    }

    // Desktop sidebar toggle
    sidebarToggle?.addEventListener('click', () => {
      sidebar?.classList.toggle('collapsed');
      const isCollapsed = sidebar?.classList.contains('collapsed');
      localStorage.setItem('ftAdminSidebarCollapsed', isCollapsed);

      // Reinitialize icons after toggle
      setTimeout(() => {
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }, 300);
    });

    // Mobile sidebar toggle
    mobileSidebarToggle?.addEventListener('click', () => {
      sidebar?.classList.toggle('mobile-open');
    });

    // User menu dropdown
    const userMenuTrigger = document.getElementById('userMenuTrigger');
    const userMenu = document.getElementById('userMenu');
    const userDropdown = document.getElementById('userDropdown');

    userMenuTrigger?.addEventListener('click', (e) => {
      e.stopPropagation();
      userMenu?.classList.toggle('open');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (userMenu && !userMenu.contains(e.target)) {
        userMenu.classList.remove('open');
      }

      // Close mobile sidebar when clicking outside
      if (sidebar && !sidebar.contains(e.target) && !mobileSidebarToggle?.contains(e.target)) {
        sidebar.classList.remove('mobile-open');
      }
    });

    // Close dropdown on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        userMenu?.classList.remove('open');
        sidebar?.classList.remove('mobile-open');
      }
    });

    // Global search functionality
    const globalSearch = document.getElementById('globalSearch');
    globalSearch?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const query = e.target.value.trim();
        if (query) {
          console.log('Search query:', query);
          // Implement search functionality here
        }
      }
    });

    // Keyboard shortcut for search (Ctrl/Cmd + K)
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        globalSearch?.focus();
      }
    });

    // Show mobile menu toggle on smaller screens
    const updateMobileToggleVisibility = () => {
      if (window.innerWidth <= 768) {
        mobileSidebarToggle.style.display = 'flex';
      } else {
        mobileSidebarToggle.style.display = 'none';
        sidebar?.classList.remove('mobile-open');
      }
    };

    updateMobileToggleVisibility();
    window.addEventListener('resize', updateMobileToggleVisibility);

    // Auto-hide notifications after timeout
    const autoHideNotifications = () => {
      const notifications = document.querySelectorAll('.alert');
      notifications.forEach(notification => {
        if (!notification.dataset.persistent) {
          setTimeout(() => {
            notification.style.transition = 'opacity 0.3s ease-out';
            notification.style.opacity = '0';
            setTimeout(() => {
              notification.remove();
            }, 300);
          }, 5000);
        }
      });
    };

    autoHideNotifications();
  </script>
</body>
</html>
