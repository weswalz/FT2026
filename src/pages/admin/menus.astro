---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getUserFromCookie, validateCSRF } from '../../lib/auth.js';
import { getAllMenus, createMenu, deleteMenu } from '../../lib/menus.js';

// Check authentication
const user = getUserFromCookie(Astro.cookies);
if (!user) {
  return Astro.redirect('/admin/login');
}

let message = null;

// Handle form submissions
if (Astro.request.method === 'POST') {
  // Validate CSRF token
  const isValidCSRF = await validateCSRF(Astro.request, Astro.cookies);
  if (!isValidCSRF) {
    return new Response('CSRF token invalid', { status: 403 });
  }

  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'create') {
    const name = formData.get('name')?.toString();
    const slug = formData.get('slug')?.toString();
    const description = formData.get('description')?.toString();
    const category = formData.get('category')?.toString();

    if (name && slug) {
      const result = createMenu({
        name,
        slug,
        description,
        category,
        status: 'published',
        updatedBy: user.username
      });

      if (result) {
        message = { type: 'success', text: 'Menu created successfully!' };
      } else {
        message = { type: 'error', text: 'Failed to create menu.' };
      }
    } else {
      message = { type: 'error', text: 'Name and slug are required.' };
    }
  } else if (action === 'delete') {
    const menuId = formData.get('menuId')?.toString();
    if (menuId) {
      const result = deleteMenu(menuId);
      if (result) {
        message = { type: 'success', text: 'Menu deleted successfully!' };
      } else {
        message = { type: 'error', text: 'Failed to delete menu.' };
      }
    }
  }
}

// Get all menus
const menus = getAllMenus();

// Format date helper
function formatDate(dateStr) {
  if (!dateStr) return 'N/A';
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

// Get CSRF token from session
const csrfToken = user.csrfToken;
---

<AdminLayout pageTitle="Menus">
  <div slot="header-actions">
    <button class="btn btn-primary" onclick="document.getElementById('createModal').style.display = 'flex'">
      <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
      Create Menu
    </button>
  </div>

  {message && (
    <div class={`alert alert-${message.type}`}>
      {message.text}
    </div>
  )}

  <!-- Menus Grid -->
  {menus.length > 0 ? (
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
      {menus.map(menu => (
        <div class="card">
          <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
            <div style="flex: 1;">
              <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--admin-text-primary); margin-bottom: 0.5rem;">
                {menu.name}
              </h3>
              {menu.category && (
                <span class="badge badge-info">{menu.category}</span>
              )}
            </div>
          </div>

          {menu.description && (
            <p style="color: var(--admin-text-secondary); font-size: 0.875rem; margin-bottom: 1rem; line-height: 1.5;">
              {menu.description}
            </p>
          )}

          <div style="display: flex; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid var(--admin-border-subtle);">
            <a href={`/admin/menus/${menu.id}`} class="btn btn-primary btn-sm" style="flex: 1;">
              <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
              Edit
            </a>
            <form method="POST" style="flex: 1;" onsubmit="return confirm('Are you sure you want to delete this menu? This will also delete all menu items.');">
              <input type="hidden" name="action" value="delete" />
              <input type="hidden" name="csrf_token" value={csrfToken} />
              <input type="hidden" name="menuId" value={menu.id} />
              <button type="submit" class="btn btn-danger btn-sm" style="width: 100%;">
                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                Delete
              </button>
            </form>
          </div>

          <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--admin-text-tertiary);">
            Updated: {formatDate(menu.updatedAt)}
          </div>
        </div>
      ))}
    </div>
  ) : (
    <div class="card" style="text-align: center; padding: 3rem;">
      <i data-lucide="utensils" style="width: 64px; height: 64px; color: var(--admin-text-tertiary); margin: 0 auto 1rem;"></i>
      <h3 style="font-size: 1.5rem; font-weight: 600; color: var(--admin-text-primary); margin-bottom: 0.5rem;">
        No Menus Yet
      </h3>
      <p style="color: var(--admin-text-secondary); margin-bottom: 1.5rem;">
        Create your first menu to get started.
      </p>
      <button class="btn btn-primary" onclick="document.getElementById('createModal').style.display = 'flex'">
        <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
        Create Menu
      </button>
    </div>
  )}

  <!-- Create Menu Modal -->
  <div id="createModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; z-index: 1000;">
    <div class="card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 class="card-title">Create New Menu</h3>
        <button onclick="document.getElementById('createModal').style.display = 'none'" style="background: none; border: none; color: var(--admin-text-secondary); cursor: pointer; font-size: 1.5rem;">
          Ã—
        </button>
      </div>

      <form method="POST">
        <input type="hidden" name="action" value="create" />
        <input type="hidden" name="csrf_token" value={csrfToken} />

        <div class="form-group">
          <label for="name" class="form-label">Menu Name *</label>
          <input
            type="text"
            id="name"
            name="name"
            class="form-input"
            placeholder="e.g., Dinner Menu"
            required
          />
        </div>

        <div class="form-group">
          <label for="slug" class="form-label">Slug *</label>
          <input
            type="text"
            id="slug"
            name="slug"
            class="form-input"
            placeholder="e.g., dinner-menu"
            required
          />
          <p class="form-helper">Used in the URL: /menu/slug</p>
        </div>

        <div class="form-group">
          <label for="category" class="form-label">Category</label>
          <input
            type="text"
            id="category"
            name="category"
            class="form-input"
            placeholder="e.g., Dinner, Lunch, Drinks"
          />
        </div>

        <div class="form-group">
          <label for="description" class="form-label">Description</label>
          <textarea
            id="description"
            name="description"
            class="form-textarea"
            placeholder="Brief description of this menu"
          ></textarea>
        </div>

        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('createModal').style.display = 'none'">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Create Menu
          </button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script>
  // Initialize Lucide icons
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }

  // Auto-generate slug from name
  const nameInput = document.getElementById('name');
  const slugInput = document.getElementById('slug');

  nameInput?.addEventListener('input', (e) => {
    const slug = e.target.value
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-|-$/g, '');
    slugInput.value = slug;
  });

  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.getElementById('createModal').style.display = 'none';
    }
  });
</script>
