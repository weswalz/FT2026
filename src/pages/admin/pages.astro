---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getUserFromCookie, validateCSRF } from '../../lib/auth.js';
import { getAllPages, createPage, deletePage } from '../../lib/pages.js';

// Check authentication
const user = getUserFromCookie(Astro.cookies);
if (!user) {
  return Astro.redirect('/admin/login');
}

let message = null;

// Handle form submissions
if (Astro.request.method === 'POST') {
  // Validate CSRF token
  const isValidCSRF = await validateCSRF(Astro.request, Astro.cookies);
  if (!isValidCSRF) {
    return new Response('CSRF token invalid', { status: 403 });
  }

  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'create') {
    const title = formData.get('title')?.toString();
    const slug = formData.get('slug')?.toString();

    if (title && slug) {
      const result = createPage({
        title,
        slug,
        sections: [],
        status: 'published',
        updatedBy: user.username
      });

      if (result) {
        message = { type: 'success', text: 'Page created successfully!' };
      } else {
        message = { type: 'error', text: 'Failed to create page. Slug may already exist.' };
      }
    } else {
      message = { type: 'error', text: 'Title and slug are required.' };
    }
  } else if (action === 'delete') {
    const pageId = formData.get('pageId')?.toString();
    if (pageId) {
      const result = deletePage(pageId);
      if (result) {
        message = { type: 'success', text: 'Page deleted successfully!' };
      } else {
        message = { type: 'error', text: 'Failed to delete page.' };
      }
    }
  }
}

// Get all pages
const pages = getAllPages();

// Format date helper
function formatDate(dateStr) {
  if (!dateStr) return 'N/A';
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

// Get CSRF token from session
const csrfToken = user.csrfToken;
---

<AdminLayout pageTitle="Pages">
  <div slot="header-actions">
    <button class="btn btn-primary" onclick="document.getElementById('createModal').style.display = 'flex'">
      <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
      Create Page
    </button>
  </div>

  {message && (
    <div class={`alert alert-${message.type}`}>
      {message.text}
    </div>
  )}

  {pages.length > 0 ? (
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Slug</th>
            <th>Status</th>
            <th>Last Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {pages.map(page => (
            <tr>
              <td style="font-weight: 600;">{page.title}</td>
              <td>
                <code style="background: var(--admin-bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8125rem;">
                  /{page.slug}
                </code>
              </td>
              <td>
                <span class={`badge ${page.status === 'published' ? 'badge-success' : 'badge-warning'}`}>
                  {page.status}
                </span>
              </td>
              <td style="color: var(--admin-text-secondary);">{formatDate(page.updatedAt)}</td>
              <td>
                <div style="display: flex; gap: 0.5rem;">
                  <a href={`/admin/pages/${page.slug}`} class="btn btn-secondary btn-sm">
                    <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
                    Edit
                  </a>
                  <a href={`/${page.slug}`} target="_blank" class="btn btn-ghost btn-sm">
                    <i data-lucide="external-link" style="width: 14px; height: 14px;"></i>
                  </a>
                  <form method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this page?');">
                    <input type="hidden" name="action" value="delete" />
                    <input type="hidden" name="csrf_token" value={csrfToken} />
                    <input type="hidden" name="pageId" value={page.id} />
                    <button type="submit" class="btn btn-danger btn-sm">
                      <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <div class="card" style="text-align: center; padding: 3rem;">
      <i data-lucide="file-text" style="width: 64px; height: 64px; color: var(--admin-text-tertiary); margin: 0 auto 1rem;"></i>
      <h3 style="font-size: 1.5rem; font-weight: 600; color: var(--admin-text-primary); margin-bottom: 0.5rem;">
        No Pages Yet
      </h3>
      <p style="color: var(--admin-text-secondary); margin-bottom: 1.5rem;">
        Create your first page to get started.
      </p>
      <button class="btn btn-primary" onclick="document.getElementById('createModal').style.display = 'flex'">
        <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
        Create Page
      </button>
    </div>
  )}

  <!-- Create Page Modal -->
  <div id="createModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; z-index: 1000;">
    <div class="card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 class="card-title">Create New Page</h3>
        <button onclick="document.getElementById('createModal').style.display = 'none'" style="background: none; border: none; color: var(--admin-text-secondary); cursor: pointer; font-size: 1.5rem;">
          Ã—
        </button>
      </div>

      <form method="POST">
        <input type="hidden" name="action" value="create" />
        <input type="hidden" name="csrf_token" value={csrfToken} />

        <div class="form-group">
          <label for="title" class="form-label">Page Title *</label>
          <input
            type="text"
            id="title"
            name="title"
            class="form-input"
            placeholder="e.g., About Us"
            required
          />
        </div>

        <div class="form-group">
          <label for="slug" class="form-label">Slug *</label>
          <input
            type="text"
            id="slug"
            name="slug"
            class="form-input"
            placeholder="e.g., about-us"
            required
          />
          <p class="form-helper">Used in the URL: /slug</p>
        </div>

        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('createModal').style.display = 'none'">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Create Page
          </button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script>
  // Initialize Lucide icons
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }

  // Auto-generate slug from title
  const titleInput = document.getElementById('title');
  const slugInput = document.getElementById('slug');

  titleInput?.addEventListener('input', (e) => {
    const slug = e.target.value
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-|-$/g, '');
    slugInput.value = slug;
  });

  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.getElementById('createModal').style.display = 'none';
    }
  });
</script>
